name: blackheart2

on:
  workflow_dispatch:
  schedule:
    - cron: '22 0 * * *'
    - cron: '18 3 * * *'
    - cron: '19 10 * * *'
    - cron: '55 15 * * *'

jobs:
  generate:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/eat-pray-ai/blackheart2:main
      credentials:
        username: ${{ github.actor }}
        password: ${{ github.token }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - id: generate
        shell: bash
        env:
          YOUTUBE_PLAYLISTS: ${{ vars.YOUTUBE_PLAYLISTS }}
        run: |
          mv ./* /blackheart2
          cd /blackheart2
          pipenv run python ./main.py
      - name: upload video
        uses: eat-pray-ai/youtube-uploader@main
        with:
          credential: ${{ secrets.YOUTUBE_CREDENTIAL }}
          token: ${{ secrets.YOUTUBE_TOKEN }}
          file: "./${{ steps.generate.outputs.title }}.mp4"
          title: ${{ steps.generate.outputs.title }}
          description: ${{ steps.generate.outputs.description }}
          tags: ${{ steps.generate.outputs.tag }}
          rest-flags: "-y ${{ steps.generate.outputs.playlistId }} -p public -g 22"
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: update token
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          cp ./youtube.token.json /blackheart2
          cd /blackheart2
          pipenv run python ./encrypt.py
